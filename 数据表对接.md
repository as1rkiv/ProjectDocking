
### 公司枚举
``` rust
/// 公司枚举
/// 从 url 中获取
/// 例：https://api.com/open/<a|b|t|o>/foo/bar
/// 
#[derive(Debug, Clone, Copy, Eq, PartialEq, Hash, Serialize, Deserialize)]
#[repr(u8)]
pub enum Company {
/// 高德 a
Amap = 0,

/// 百度 b
Baidu = 1,

/// 腾讯 t
Tencent = 2,

/// 自己 o
Own = 3,
}
```

### 平台表
``` sql
CREATE TABLE `platform` (
	`id` BIGINT AUTO_INCREMENT COMMENT '平台ID',
	`name` VARCHAR(255) NOT NULL COMMENT '平台名称',
	PRIMARY KEY (`id`)
) ENGINE = InnoDB COMMENT = '平台表';

INSERT INTO `platform` (`name`)
VALUES ('Web 服务'), ('iOS 平台'), ('Android 平台'), ('JS API'), ('微信小程序'), ('智能硬件'), ('HarmonyOS NEXT 平台');
```

### 服务

#### 服务入口

##### 服务入口表

关联表：[[#平台表]]
关联枚举：[[#公司枚举]]
``` sql
-- 我方暴露给客户调用功能的服务抽象
-- 客户KEY的调用量对应此表中的项
-- 客户通过组合起来的完整url调用我方服务
-- 例如高德正地理编码接口为：https://restapi.amap.com/v3/geocode/geo
-- 需要录入的uri为：v3/geocode/geo
-- 网关会根据platform自动补全，a、b、t、o
-- 我方服务地址为：https://xxx.com/open/a/v3/geocode/geo
-- 新增或修改时需要验证：相同company下是否存在相同的uri
CREATE TABLE `service_entry` (
	`id` BIGINT AUTO_INCREMENT COMMENT '服务入口ID',
	`platform_id` BIGINT NOT NULL COMMENT '平台ID',
	`company` TINYINT UNSIGNED NOT NULL COMMENT '所属公司：高德 腾讯 百度 自己',
	`name` VARCHAR(255) DEFAULT '' COMMENT '服务入口名称',
	`uri` VARCHAR(255) DEFAULT '' COMMENT '映射路由',
	`aggregate` BOOLEAN NOT NULL DEFAULT 0 COMMENT '聚合状态：直连｜聚合',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '服务能力描述',
	`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间, 自动',
	`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间, 自动',

	PRIMARY KEY (`id`),
	INDEX (`platform_id`),
	INDEX (`company`),
	INDEX (`name`),
	INDEX (`uri`)
) ENGINE = InnoDB COMMENT = '服务入口表';
```

##### 服务入口分组表（≈客户计费模版）

关联表：[[#平台表]]
关联枚举：[[#公司枚举]]
``` sql
-- 生成客户KEY时可以快速选择某组服务接口
-- 与 资源服务分组 不同的是，该表用来做面向客户的计费模版
-- 资源轮转：例如高德猎鹰服务需要始终保持相同的资源KEY，才可以访问到之前创建的轨迹，但其他接口则可以每次使用不同的资源KEY
CREATE TABLE `service_entry_group` (
	`id` BIGINT AUTO_INCREMENT COMMENT '组ID',
	`platform_id` BIGINT NOT NULL COMMENT '平台ID',
	`company` TINYINT UNSIGNED NOT NULL COMMENT '公司：高德 腾讯 百度 自有',
	`name` VARCHAR(255) DEFAULT '' COMMENT '组名称',
	`reset_cycle` TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '计费重置周期：Daily = 0, Monthly = 1',
	`share_quota` BOOLEAN DEFAULT 0 COMMENT '是否组内服务用量共享',
	`resource_rotate` BOOLEAN DEFAULT 1 COMMENT '资源KEY轮转',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '分类描述',
	`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间, 自动',
	`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间, 自动',

	PRIMARY KEY (`id`),
	INDEX (`platform_id`),
	INDEX (`company`),
	INDEX (`name`)
) ENGINE = InnoDB COMMENT = '服务入口分组表';
```

##### 服务入口分组关联表

关联表：[[#服务入口分组表（≈客户计费模版）]]、[[#服务入口]]
``` sql
-- 多对多
-- 关联 客户服务分组 与 API服务接口
-- 
CREATE TABLE `service_entry_group_link` (
	`id` BIGINT AUTO_INCREMENT COMMENT '关联ID',
	`s_entry_group_id` BIGINT NOT NULL COMMENT '服务入口分组ID',
	`s_entry_id` BIGINT NOT NULL COMMENT '服务入口ID',

	PRIMARY KEY (`id`),
	INDEX (`s_entry_group_id`, `s_entry_id`)
) ENGINE = InnoDB COMMENT = '服务入口分组关联表';
```

#### 服务能力

##### 服务能力表

关联表：[[#平台表]]
关联枚举：[[#公司枚举]]
``` sql
-- 各平台的真实服务抽象
-- 资源KEY的调用量对应此表中的项
-- 各个真实接口的独立服务，通过此项的ID接入聚合层
-- 后期阶段可以通过自有的数据库，封装为独立的服务，接入到系统中
CREATE TABLE `service_ability` (
	`id` BIGINT AUTO_INCREMENT COMMENT '服务能力ID',
	`platform_id` BIGINT NOT NULL COMMENT '平台ID',
	`company` TINYINT UNSIGNED NOT NULL COMMENT '所属公司：高德 腾讯 百度 自己',
	`name` VARCHAR(255) DEFAULT '' COMMENT '服务能力名称',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '服务能力描述',
	`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间, 自动',
	`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间, 自动',

	PRIMARY KEY (`id`),
	INDEX (`platform_id`),
	INDEX (`company`),
	INDEX (`name`),
) ENGINE = InnoDB COMMENT = '服务能力表';
```

##### 服务能力分组表（≈资源计费模版）

关联表：[[#平台表]]
关联枚举：[[#公司枚举]]
``` sql
-- 适配高德、百度、腾讯下的接口功能划分，如基础服务、高级服务、猎鹰服务等
-- 添加资源KEY时可以根据KEY的权限快速选择，约等于计费模版
-- 此处按照高德 腾讯 百度原接口功能划分与原计费方式录入
--
-- 计费周期：某些分组的接口采用按日重置，某些则是按月
-- 用量共享：如高德WEB基础LBS服务，会根据KEY的不同，采用多个接口共用一个限额
-- 例如：高德-基础LBS服务-配额独立、高德-基础LBS服务-配额共享
CREATE TABLE `service_ability_group` (
	`id` BIGINT AUTO_INCREMENT COMMENT '组ID',
	`platform_id` BIGINT NOT NULL COMMENT '平台ID',
	`company` TINYINT UNSIGNED NOT NULL COMMENT '公司：高德 腾讯 百度',
	`name` VARCHAR(255) DEFAULT '' COMMENT '组名称',
	`reset_cycle` TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '组内服务能力重置周期：Daily = 0, Monthly = 1',
	`share_quota` BOOLEAN DEFAULT 0 COMMENT '组内服务配额共享',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '组描述',
	`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间, 自动',
	`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间, 自动',

	PRIMARY KEY (`id`),
	INDEX (`platform_id`),
	INDEX (`company`),
	INDEX (`name`)
) ENGINE = InnoDB COMMENT = '服务能力分组表';
```

##### 服务能力分组关联表

关联表：[[#服务能力分组表（≈资源计费模版）]]、[[#服务能力表]]
``` sql
-- 多对多
-- 关联 服务分组 与真实的 服务能力抽象
-- 
CREATE TABLE `service_ability_group_link` (
	`id` BIGINT AUTO_INCREMENT COMMENT '关联ID',
	`s_ability_group_id` BIGINT NOT NULL COMMENT '服务能力分组ID',
	`s_ability_id` BIGINT NOT NULL COMMENT '服务能力ID',

	PRIMARY KEY (`id`),
	INDEX (`s_ability_group_id`, `s_ability_id`)
) ENGINE = InnoDB COMMENT = '服务能力分组关联表';
```

##### 服务入口与能力关联表

关联表：[[#服务入口表]]、[[#服务能力表]]
``` sql
-- 多对多
-- 关联 服务入口抽象 与真实的 服务能力抽象
-- 通过此种关联，使一个对外暴露给客户的url接口，可以调用多个平台的同类型能力，完成聚合响应
CREATE TABLE `service_entry_ability_link` (
	`id` BIGINT AUTO_INCREMENT COMMENT '关联ID',
	`s_entry_id` BIGINT NOT NULL COMMENT '服务入口ID',
	`s_ability_id` BIGINT NOT NULL COMMENT '服务能力ID',

	PRIMARY KEY (`id`),
	INDEX (`s_entry_id`, `s_ability_id`)
) ENGINE = InnoDB COMMENT = '服务入口能力关联表';
```

### 资源
*资源中的 `company` 字段不需要 `自己` 这个角色*
##### 资源池表

关联表：[[#平台表]]
关联枚举：[[#公司枚举]]
``` sql
-- 资源池，池1池2
-- 用来限制客户请求时，可使用的资源KEY集合
CREATE TABLE `resource_pool` (
	`id` BIGINT AUTO_INCREMENT COMMENT '资源池ID',
	`platform_id` BIGINT NOT NULL COMMENT '平台ID',
	`company` TINYINT UNSIGNED NOT NULL COMMENT '公司：高德 腾讯 百度',
	`name` VARCHAR(255) DEFAULT '' COMMENT '资源池名称',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '资源池描述',
	`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间, 自动',
	`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间, 自动',
	
	PRIMARY KEY (`id`),
	INDEX (`platform_id`),
	INDEX (`company`),
	INDEX (`name`)
) ENGINE = InnoDB COMMENT = '资源池表';
```

##### 资源KEY表

关联表：[[#平台表]]、[[#资源池表]]
关联枚举：[[#公司枚举]]
``` sql
-- 高德 腾讯 百度 的原KEY录入
-- 此处的company不包含自己，只需要录入高德 腾讯 百度3家的KEY
-- 每个KEY只绑定一个资源池
CREATE TABLE `resource_key` (
	`id` BIGINT AUTO_INCREMENT COMMENT 'Key ID',
	`r_pool_id` BIGINT NOT NULL COMMENT '资源池ID',
	`platform_id` BIGINT NOT NULL COMMENT '平台ID',
	`company` TINYINT UNSIGNED NOT NULL COMMENT '公司：高德 腾讯 百度',
	`name` VARCHAR(255) DEFAULT '' COMMENT '资源名称',
	`key` VARCHAR(255) DEFAULT '' COMMENT '资源KEY',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '资源描述',
	`reset_day` INT UNSIGNED NOT NULL COMMENT '每月重置日',
	`last_reset_time` DATETIME DEFAULT NULL COMMENT '上次重置时间',
	`expired_time` DATETIME NOT NULL COMMENT '到期时间',
	`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间, 自动',
	`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间, 自动',

	PRIMARY KEY (`id`),
	INDEX (`r_pool_id`),
	INDEX (`platform_id`),
	INDEX (`company`),
	INDEX (`name`),
	INDEX (`key`)
) ENGINE = InnoDB COMMENT = '资源KEY表';
```

##### 资源KEY配额表
``` sql 
CREATE TABLE `resource_key_quota` (
	`id` BIGINT AUTO_INCREMENT COMMENT '配额ID',
	`used_count` BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '当前调用次数',
	`limit_count` BIGINT UNSIGNED NOT NULL COMMENT '调用次数上限',
	PRIMARY KEY (`id`)
) ENGINE = InnoDB COMMENT = '资源KEY配额表';
```

##### 资源KEY服务能力配额关联表

关联表：[[#资源KEY表]]、[[#服务能力分组关联表]]、[[#资源KEY配额表]]
``` sql
-- 绑定资源KEY
-- 真实服务能力在不同模版下的重置周期与配额计算方式不同
-- 所以这里直接使用 *资源与服务能力分组关联表* 中的关联ID
-- 保持真实服务能力唯一性的同时，又能根据不同的KEY权限实现不同的计费方式
-- 配额节点加载时，只需要关联查询相关的表，即可获得不同KEY下不同接口的重置周期
-- 资源KEY的配额数据也可共享可独立
-- *并发量控制次数*，在不同服务能力、不同的KEY下都不相同，所以在此单独设置
CREATE TABLE `resource_key_service_ability_quota_link` (
	`r_key_id` BIGINT NOT NULL COMMENT '资源KEY ID',
	`s_ability_group_link_id` BIGINT NOT NULL COMMENT '服务能力分组关联ID',
	`r_key_quota_id` BIGINT NOT NULL COMMENT '资源KEY配额ID',
	`concurrent_limit` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '并发次数上限（次/秒）',
	
	PRIMARY KEY (`r_key_id`, `s_ability_group_link_id`),
	INDEX (`r_key_quota_id`)
) ENGINE = InnoDB COMMENT = '资源KEY服务能力配额关联表';
``` 

### 客户

##### 客户信息表
``` sql
-- 用来记录客户资料，方便后续根据客户KEY中的客户ID快速查询
CREATE TABLE `client` (
	`id` BIGINT AUTO_INCREMENT COMMENT '客户ID',
	`name` VARCHAR(255) DEFAULT '' COMMENT '客户名称',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '客户描述',
	...
	
	
	PRIMARY KEY (`id`),
	INDEX (`name`)
) ENGINE = InnoDB COMMENT = '客户表';
```

##### 客户KEY表

关联表：[[#客户信息表]]、[[#平台表]]
关联枚举：[[#公司枚举]]
``` sql
-- 供客户访问服务的KEY
CREATE TABLE `client_key` (
	`id` BIGINT AUTO_INCREMENT COMMENT 'Key ID',
	`client_id` BIGINT NOT NULL COMMENT '客户ID',
	`platform_id` BIGINT NOT NULL COMMENT '平台ID',
	`company` TINYINT UNSIGNED NOT NULL COMMENT '公司：高德 腾讯 百度 自己',
	`name` VARCHAR(255) DEFAULT '' COMMENT '名称',
	`key` VARCHAR(255) DEFAULT '' COMMENT 'KEY',
	`desc` VARCHAR(1000) DEFAULT '' COMMENT '描述',
	`expired_time` DATETIME NOT NULL COMMENT '到期时间',
	`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间, 自动',
	`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间, 自动',

	PRIMARY KEY (`id`),
	INDEX (`client_id`),
	INDEX (`platform_id`),
	INDEX (`company`),
	INDEX (`name`),
	INDEX (`key`)
) ENGINE = InnoDB COMMENT = '客户Key表';
```

##### 客户KEY IP限制表
``` sql
-- 请求IP限制
CREATE TABLE `client_key_ip_scope` (
	`id` BIGINT AUTO_INCREMENT COMMENT 'ID',
	`c_key_id` BIGINT NOT NULL COMMENT '客户KEY ID',
	`ip` VARCHAR(255) DEFAULT '' COMMENT 'IP',
	
	PRIMARY KEY (`id`),
	INDEX (`c_key_id`),
	INDEX (`ip`)
) ENGINE = InnoDB COMMENT = '客户KEY IP限制表';
```

##### 客户KEY指定资源池

关联表：[[#客户KEY表]]、[[#资源池表]]
``` sql
-- 绑定客户KEY使用指定资源池
CREATE TABLE `client_key_resource_pool` (
	`id` BIGINT AUTO_INCREMENT COMMENT 'ID',
	`c_key_id` BIGINT NOT NULL COMMENT '客户KEY ID',
	`r_pool_id` BIGINT NOT NULL COMMENT '资源池 ID',
	
	PRIMARY KEY (`id`),
	INDEX (`c_key_id`),
	INDEX (`r_pool_id`)
) ENGINE = InnoDB COMMENT = '客户KEY指定资源池表';
```

##### 客户KEY指定资源KEY表

关联表：[[#客户KEY表]]、[[#资源KEY表]]
``` sql
-- 某些公司的部分接口，必须使用相同的资源KEY才可访问之前创建的数据
CREATE TABLE `client_key_resource_key` (
	`id` BIGINT AUTO_INCREMENT COMMENT 'ID',
	`c_key_id` BIGINT NOT NULL COMMENT '客户KEY ID',
	`r_key_id` BIGINT NOT NULL COMMENT '资源KEY ID',
	
	PRIMARY KEY (`id`),
	INDEX (`c_key_id`),
	INDEX (`r_key_id`)
) ENGINE = InnoDB COMMENT = '客户KEY指定资源表';
```

##### 客户KEY配额表
``` sql
CREATE TABLE `client_key_quota` (
	`id` BIGINT AUTO_INCREMENT COMMENT '配额ID',
	`used_count` BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '当前调用次数',
	`limit_count` BIGINT UNSIGNED NOT NULL COMMENT '调用次数上限',
	
	PRIMARY KEY (`id`)
) ENGINE = InnoDB COMMENT = '客户KEY配额表';
```

##### 客户KEY服务入口配额关联表

关联表：[[#客户KEY表]]、[[#服务入口分组关联表]]、[[#客户KEY配额表]]
``` sql
CREATE TABLE `client_key_service_entry_quota_link` (
	`c_key_id` BIGINT NOT NULL COMMENT '客户KEY ID',
	`s_entry_group_link` BIGINT NOT NULL COMMENT '服务入口分组关联ID',
	`c_key_quota_id` BIGINT NOT NULL COMMENT '客户KEY配额ID',
	`concurrent_limit` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '并发次数上限（次/秒）',
	
	PRIMARY KEY (`c_key_id`, `s_entry_group_link`),
	INDEX (`c_key_quota_id`)
) ENGINE = InnoDB COMMENT = '客户KEY服务入口配额关联表';
``` 
